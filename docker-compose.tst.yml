services:
  backend:
    build:
      context: .
    ports:
      - 3000:3000
    env_file: ./backend/.development.env
    environment:
      DATABASE_URL: "postgres://postgres:abc123@postgres:5432/postgres"
    volumes:
      - ./backend/src/migrations:/app/src/migrations
    depends_on:
      - postgres
      - testMySQL-e2e-testing
      - testPg-e2e-testing
      - mssql-e2e-testing
      - test-oracle-e2e-testing
      - test-ibm-db2-e2e-testing
      - test-dynamodb-e2e-testing
    links:
      - postgres
      - testMySQL-e2e-testing
      - testPg-e2e-testing
      - mssql-e2e-testing
      - test-oracle-e2e-testing
      - test-ibm-db2-e2e-testing
      - test-dynamodb-e2e-testing
    command: ["yarn", "start"]
  backend_test:
    build:
      context: .
    env_file: ./backend/.development.env
    environment:
      DATABASE_URL: "postgres://postgres:abc123@postgres:5432/postgres"
      EXTRA_ARGS: "${EXTRA_ARGS:-}"
    volumes:
      - ./backend/src/migrations:/app/src/migrations
    depends_on:
      postgres:
        condition: service_healthy
      testMySQL-e2e-testing:
        condition: service_healthy
      testPg-e2e-testing:
        condition: service_healthy
      mssql-e2e-testing:
        condition: service_healthy
      test-oracle-e2e-testing:
        condition: service_healthy
      test-ibm-db2-e2e-testing:
        condition: service_healthy
      test-mongo-e2e-testing:
        condition: service_healthy
      test-dynamodb-e2e-testing:
        condition: service_healthy
      test-redis-e2e-testing:
        condition: service_healthy
    command: ["/bin/sh", "-c", "yarn test $EXTRA_ARGS"]
    develop:
      watch:
        - action: rebuild
          path: ./backend/src

  testMySQL-e2e-testing:
    image: mysql:8.0.23
    ports:
      - 3308:3306
    tmpfs:
      - /var/lib/mysql
    environment:
      MYSQL_ROOT_PASSWORD: 123
      MYSQL_DATABASE: testDB
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-p123"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s

  testPg-e2e-testing:
    image: postgres
    ports:
      - 9002:5432
    environment:
      POSTGRES_PASSWORD: 123
    command: postgres -c 'max_connections=300'
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 10s

  test-mongo-e2e-testing:
    image: mongo
    restart: always
    environment:
      MONGO_INITDB_ROOT_USERNAME: root
      MONGO_INITDB_ROOT_PASSWORD: example
    ports:
      - 27017:27017
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s

  postgres:
    image: postgres
    ports:
      - 5432:5432
    environment:
      POSTGRES_PASSWORD: abc123
    command: postgres -c 'max_connections=300'
    tmpfs:
      - /var/lib/postgresql
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 10s

  mssql-e2e-testing:
    image: mcr.microsoft.com/mssql/server:2019-latest
    environment:
      - SA_PASSWORD=yNuXf@6T#BgoQ%U6knMp
      - ACCEPT_EULA=Y
    ports:
      - "5434:1433"
    healthcheck:
      test: ["CMD-SHELL", "/opt/mssql-tools18/bin/sqlcmd -S localhost -U sa -P 'yNuXf@6T#BgoQ%U6knMp' -C -Q 'SELECT 1' || /opt/mssql-tools/bin/sqlcmd -S localhost -U sa -P 'yNuXf@6T#BgoQ%U6knMp' -Q 'SELECT 1'"]
      interval: 10s
      timeout: 5s
      retries: 20
      start_period: 60s

  test-oracle-e2e-testing:
    image: gvenzl/oracle-xe
    ports:
      - 1521:1521
    environment:
      ORACLE_PASSWORD: 12345
    healthcheck:
      test: ["CMD-SHELL", "healthcheck.sh"]
      interval: 10s
      timeout: 5s
      retries: 30
      start_period: 120s

  autoadmin-ws-server:
    build:
      context: autoadmin-ws-server
    ports:
      - 8008:8008
    env_file: ./autoadmin-ws-server/.ws-server-development.env
    volumes:
      - ./autoadmin-ws-server/dist:/app/dist
      - ./autoadmin-ws-server/src:/app/src
    links:
      - backend
    depends_on:
      - backend

  test-redis-e2e-testing:
    image: redis:7.0.11
    command: ["redis-server", "--requirepass", "SuperSecretRedisPassword"]
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 30s
      timeout: 10s
      retries: 3

  # rocketadmin-agent_oracle:
  #   build:
  #     context: .
  #     dockerfile: ./rocketadmin-agent/Dockerfile
  #   ports:
  #     - 8088:8088
  #   volumes:
  #     - ./rocketadmin-agent/dist:/app/dist
  #     - ./rocketadmin-agent/src:/app/src
  #   links:
  #     - autoadmin-ws-server
  #   depends_on:
  #     - autoadmin-ws-server
  #   environment:
  #     - REMOTE_WEBSOCKET_ADDRESS=ws://autoadmin-ws-server:8009
  #     - APPLICATION_CONFIG_FILE_NAME=.oracle_test_agent_config.txt
  #   command: ["yarn", "start:dev"]

  # rocketadmin-agent_postgres:
  #   build:
  #     context: .
  #     dockerfile: ./rocketadmin-agent/Dockerfile
  #   ports:
  #     - 8098:8098
  #   volumes:
  #     - ./rocketadmin-agent/dist:/app/dist
  #     - ./rocketadmin-agent/src:/app/src
  #   links:
  #     - autoadmin-ws-server
  #   depends_on:
  #     - autoadmin-ws-server
  #   environment:
  #     - REMOTE_WEBSOCKET_ADDRESS=ws://autoadmin-ws-server:8009
  #     - APPLICATION_CONFIG_FILE_NAME=.postgres_test_agent_config.txt
  #   command: ["yarn", "start:dev"]

  # rocketadmin-agent_mysql:
  #   build:
  #     context: .
  #     dockerfile: ./rocketadmin-agent/Dockerfile
  #   ports:
  #     - 8108:8108
  #   volumes:
  #     - ./rocketadmin-agent/dist:/app/dist
  #     - ./rocketadmin-agent/src:/app/src
  #   links:
  #     - autoadmin-ws-server
  #   depends_on:
  #     - autoadmin-ws-server
  #   environment:
  #     - REMOTE_WEBSOCKET_ADDRESS=ws://autoadmin-ws-server:8009
  #     - APPLICATION_CONFIG_FILE_NAME=.mysql_test_agent_config.txt
  #   command: ["yarn", "start:dev"]

  # rocketadmin-agent_mssql:
  #   build:
  #     context: .
  #     dockerfile: ./rocketadmin-agent/Dockerfile
  #   ports:
  #     - 8118:8118
  #   volumes:
  #     - ./rocketadmin-agent/dist:/app/dist
  #     - ./rocketadmin-agent/src:/app/src
  #   links:
  #     - autoadmin-ws-server
  #   depends_on:
  #     - autoadmin-ws-server
  #   environment:
  #     - REMOTE_WEBSOCKET_ADDRESS=ws://autoadmin-ws-server:8009
  #     - APPLICATION_CONFIG_FILE_NAME=.mssql_test_agent_config.txt
  #   command: ["yarn", "start:dev"]

  # rocketadmin-agent_ibmdb2:
  #   build:
  #     context: .
  #     dockerfile: ./rocketadmin-agent/Dockerfile
  #   ports:
  #     - 8308:8308
  #   volumes:
  #     - ./rocketadmin-agent/dist:/app/dist
  #     - ./rocketadmin-agent/src:/app/src
  #     - ./rocketadmin-agent/wait-for-db2.sh:/app/wait-for-db2.sh
  #   links:
  #     - autoadmin-ws-server
  #   depends_on:
  #     - autoadmin-ws-server
  #   environment:
  #     - REMOTE_WEBSOCKET_ADDRESS=ws://autoadmin-ws-server:8009
  #     - APPLICATION_CONFIG_FILE_NAME=.ibmdb2_test_agent_config.txt
  #   command: ["/bin/sh", "/app/wait-for-db2.sh"]

  test-ibm-db2-e2e-testing:
    image: icr.io/db2_community/db2
    restart: always
    privileged: true
    environment:
      - LICENSE=accept
      - DB2INSTANCE=db2inst1
      - DB2INST1_PASSWORD=password
      - DBNAME=testdb
      - BLU=false
      - ENABLE_ORACLE_COMPATIBILITY=false
      - UPDATEAVAIL=NO
      - TO_CREATE_SAMPLEDB=true
      - REPODB=false
      - IS_OSXFS=false
      - PERSISTENT_HOME=true
      - HADR_ENABLED=false
      - ETCD_ENDPOINT=
      - ETCD_USERNAME=
      - ETCD_PASSWORD=
    ports:
      - 50000:50000
    healthcheck:
      test: ["CMD-SHELL", "su - db2inst1 -c 'db2 connect to testdb'"]
      interval: 30s
      timeout: 30s
      retries: 20
      start_period: 180s

  test-dynamodb-e2e-testing:
    image: amazon/dynamodb-local
    environment:
      - AWS_ACCESS_KEY_ID=SuperSecretAwsAccessKey
      - AWS_SECRET=SuperSecretAwsSecret
    ports:
      - 8000:8000
    healthcheck:
      test: ["CMD-SHELL", "curl -s http://localhost:8000 || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 10s
