<div class="ai-panel-sidebar ai-panel-sidebar_open"
    [ngClass]="{'ai-panel-sidebar_expanded': isExpanded}">
</div>
<div class="ai-panel-sidebar-content ai-panel-sidebar-content_open"
    [ngClass]="{'ai-panel-sidebar-content_expanded': isExpanded, 'ai-panel-sidebar-content_sidebar-collapsed': !sidebarExpanded}">
    <div class="ai-panel-sidebar__header">
        <h2 class="mat-heading-2 ai-panel-sidebar__title">
            <mat-icon svgIcon="ai_rocket" class="ai-icon"></mat-icon>
            <span *ngIf="isExpanded">AI insights for {{displayName}}</span>
            <span *ngIf="!isExpanded">AI insights</span>
        </h2>
        <div class="ai-panel-sidebar__actions">
            <button mat-icon-button (click)="toggleExpand()">
                <mat-icon>{{isExpanded ? 'close_fullscreen' : 'open_in_full'}}</mat-icon>
            </button>
            <button mat-icon-button (click)="handleClose()">
                <mat-icon>close</mat-icon>
            </button>
        </div>
    </div>

    <div class="ai-panel-chat">
        <div *ngIf="messagesChain.length; else suggestions" class="ai-message-chain-box" #chatContainer>
            <div class="ai-message-chain">
                <div *ngFor="let message of messagesChain" class="{{message.type}}-message">
                    <span style="white-space: pre-wrap" *ngIf="message.type == 'user'">{{message.text}}</span>
                    <markdown *ngIf="message.type == 'ai'" mermaid>{{message.text}}</markdown>
                </div>
            </div>
        </div>

        <ng-template #suggestions>
            <div class="ai-welcome-centered">
                <div class="ai-welcome-centered__content">
                    <p class="ai-welcome-centered__title">Ask anything about your data</p>

                    <div class="ai-input-wrapper">
                        <form (ngSubmit)="createThread()" class="ai-welcome-form">
                            <mat-form-field appearance="outline" class="ai-welcome-form__field">
                                <mat-label>Ask a question about this table...</mat-label>
                                <input matInput
                                    name="welcomeMessage"
                                    [(ngModel)]="message"
                                    (input)="onWelcomeInputChange()"
                                    (focus)="onWelcomeInputFocus()"
                                    (blur)="onWelcomeInputBlur()"
                                    autocomplete="off"
                                    maxlength="255">
                                <button mat-icon-button matSuffix type="submit" class="ai-welcome-form__button">
                                    <mat-icon>send</mat-icon>
                                </button>
                            </mat-form-field>
                        </form>

                        <div class="ai-completions" *ngIf="showCompletions && activeCompletions.length">
                            <button *ngFor="let completion of activeCompletions"
                                class="ai-completion-item"
                                (mousedown)="selectCompletion(completion)">
                                <span class="ai-completion-text">{{completion}}</span>
                            </button>
                        </div>
                    </div>

                    <div class="ai-categories">
                        <div class="ai-category" *ngFor="let category of suggestionCategories">
                            <p class="ai-category__title">{{category.title}}</p>
                            <div class="ai-category__chips">
                                <button *ngFor="let suggestion of category.suggestions"
                                    class="suggestion-chip"
                                    [class.suggestion-chip_active]="activeSuggestion?.title === suggestion.title"
                                    (click)="onSuggestionChipClick(suggestion)">
                                    <span>{{suggestion.title}}</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </ng-template>

        <div class="loading" *ngIf="submitting">
            <div class="loading-content">
                <span class="loading-text">Generating an answer</span>
                <div class="loading-dots">
                    <span class="loading-dot"></span>
                    <span class="loading-dot"></span>
                    <span class="loading-dot"></span>
                </div>
            </div>
        </div>

        <form *ngIf="messagesChain.length" (ngSubmit)="threadID ? sendMessage() : createThread()" class="ai-message-form">
            <mat-form-field class="form-field" appearance="outline" class="ai-message-form__textarea">
                <mat-label class="ai-message-form__label">Ask a question about this table...</mat-label>
                <textarea matInput name="message"
                    class="ai-panel-sidebar__message"
                    [rows]="textareaRows"
                    data-testid="user-message"
                    maxlength="255"
                    (keydown)="onKeydown($event)"
                    [(ngModel)]="message">
                </textarea>
            </mat-form-field>

            <div class="ai-message-form__footer">
                <span class="ai-message-form__char-count">{{charactrsNumber}} / 256</span>
                <button mat-icon-button type="submit"
                    class="ai-message-form__button">
                    <mat-icon>send</mat-icon>
                </button>
            </div>
        </form>

        <div class="footer" *ngIf="messagesChain.length">
            <p class="mat-small">
                AI may provide inaccurate responses.<br/>Check our <a href="https://rocketadmin.com/privacy/" class="link">Privacy policy</a>.
            </p>
        </div>
    </div>
</div>
