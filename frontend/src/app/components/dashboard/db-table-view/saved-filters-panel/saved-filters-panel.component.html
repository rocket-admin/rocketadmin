<div class="saved-filters-container">
    <app-placeholder-saved-filters *ngIf="savedFilterData === null"></app-placeholder-saved-filters>
    <div *ngIf="savedFilterData" class="saved-filters-list">
        <button *ngIf="accessLevel === 'edit' && savedFilterData?.length === 0"
            class="saved-filters-list__first-time-button"
            mat-button type="button"
            angulartics2On="click"
            angularticsAction="Saved filters: first time setup is clicked"
            (click)="handleOpenSavedFiltersDialog()">
            <mat-icon>tune</mat-icon>
            Create fast filter
        </button>

        <button *ngIf="accessLevel === 'edit' && savedFilterData.length !== 0"
            mat-icon-button type="button"
            matTooltip="Set up, edit, or remove fast filters"
            [matMenuTriggerFor]="menu"
            angulartics2On="click"
            angularticsAction="Saved filters: open menu is clicked">
            <mat-icon>tune</mat-icon>
        </button>
        <mat-menu #menu="matMenu">
            <button mat-menu-item (click)="handleOpenSavedFiltersDialog()">
                <mat-icon>add</mat-icon>
                New fast filter
            </button>
            <button mat-menu-item
                *ngFor="let filter of savedFilterData"
                (click)="handleOpenSavedFiltersDialog(filter)">
                {{ filter.name }}
            </button>
        </mat-menu>

        <mat-chip-listbox [value]="selectedFilterSetId" class="saved-filters-tabs">
            <mat-chip-option *ngFor="let filter of savedFilterData"
                [value]="filter.id"
                (click)="selectFiltersSet(filter.id)">
                {{ filter.name }}
            </mat-chip-option>
        </mat-chip-listbox>
    </div>

    <div class="filters-container">
        <form *ngIf="savedFilterMap[selectedFilterSetId]?.dynamicColumn"
            class="dynamic-column-editor"
            (ngSubmit)="applyDynamicColumnChanges()">
            <!-- Column name and operator in one row -->
            <span class="column-name mat-body-1" *ngIf="getComparatorType(getInputType(savedFilterMap[selectedFilterSetId]?.dynamicColumn.column)) !== 'nonComparable'">
                <strong>{{ savedFilterMap[selectedFilterSetId]?.dynamicColumn.column }}</strong>
                <span class="comparator-text">
                    {{ getOperatorText(savedFilterMap[selectedFilterSetId]?.dynamicColumn.operator || 'eq') }}
                </span>
            </span>

            <!-- Non-comparable field (uses ndc-dynamic) -->
            <div *ngIf="getComparatorType(getInputType(savedFilterMap[selectedFilterSetId]?.dynamicColumn.column)) === 'nonComparable'">
                <div *ngIf="isWidget(savedFilterMap[selectedFilterSetId]?.dynamicColumn.column); else defaultDynamicField">
                    <ndc-dynamic [ndcDynamicComponent]="tableWidgets[savedFilterMap[selectedFilterSetId]?.dynamicColumn.column].widget_type ? UIwidgets[tableWidgets[savedFilterMap[selectedFilterSetId]?.dynamicColumn.column].widget_type] : inputs[tableTypes[savedFilterMap[selectedFilterSetId]?.dynamicColumn.column]]"
                        [ndcDynamicInputs]="{
                            key: savedFilterMap[selectedFilterSetId]?.dynamicColumn.column,
                            label: tableWidgets[savedFilterMap[selectedFilterSetId]?.dynamicColumn.column].name || savedFilterMap[selectedFilterSetId]?.dynamicColumn.column,
                            value: savedFilterMap[selectedFilterSetId]?.dynamicColumn.value,
                            widgetStructure: tableWidgets[savedFilterMap[selectedFilterSetId]?.dynamicColumn.column],
                            relations: tableTypes[savedFilterMap[selectedFilterSetId]?.dynamicColumn.column] === 'foreign key' ? tableForeignKeys[savedFilterMap[selectedFilterSetId]?.dynamicColumn.column] : undefined,
                            autofocus: shouldAutofocus
                        }"
                        [ndcDynamicOutputs]="{
                            onFieldChange: { handler: updateDynamicColumnValue, args: ['$event'] }
                        }"
                    ></ndc-dynamic>
                </div>

                <ng-template #defaultDynamicField>
                    <ndc-dynamic [ndcDynamicComponent]="inputs[tableTypes[savedFilterMap[selectedFilterSetId]?.dynamicColumn.column]]"
                        [ndcDynamicInputs]="{
                            key: savedFilterMap[selectedFilterSetId]?.dynamicColumn.column,
                            label: savedFilterMap[selectedFilterSetId]?.dynamicColumn.column,
                            value: savedFilterMap[selectedFilterSetId]?.dynamicColumn.value,
                            structure: tableRowStructure[savedFilterMap[selectedFilterSetId]?.dynamicColumn.column],
                            relations: tableTypes[savedFilterMap[selectedFilterSetId]?.dynamicColumn.column] === 'foreign key' ? tableForeignKeys[savedFilterMap[selectedFilterSetId]?.dynamicColumn.column] : undefined,
                            autofocus: shouldAutofocus
                        }"
                        [ndcDynamicOutputs]="{
                            onFieldChange: { handler: updateDynamicColumnValue, args: ['$event'] }
                        }"
                    ></ndc-dynamic>
                </ng-template>
            </div>

            <!-- Standard field value input for text and number types -->
            <div *ngIf="getComparatorType(getInputType(savedFilterMap[selectedFilterSetId]?.dynamicColumn.column)) !== 'nonComparable'">
                <ndc-dynamic [ndcDynamicComponent]="inputs[tableTypes[savedFilterMap[selectedFilterSetId]?.dynamicColumn.column]]"
                    [ndcDynamicInputs]="{
                        key: savedFilterMap[selectedFilterSetId]?.dynamicColumn.column,
                        label: savedFilterMap[selectedFilterSetId]?.dynamicColumn.column,
                        value: savedFilterMap[selectedFilterSetId]?.dynamicColumn.value,
                        readonly: savedFilterMap[selectedFilterSetId]?.dynamicColumn.operator === 'empty',
                        structure: tableRowStructure[savedFilterMap[selectedFilterSetId]?.dynamicColumn.column],
                        relations: tableTypes[savedFilterMap[selectedFilterSetId]?.dynamicColumn.column] === 'foreign key' ? tableForeignKeys[savedFilterMap[selectedFilterSetId]?.dynamicColumn.column] : undefined,
                        autofocus: shouldAutofocus
                    }"
                    [ndcDynamicOutputs]="{
                        onFieldChange: { handler: updateDynamicColumnValue, args: ['$event'] }
                    }"
                ></ndc-dynamic>
            </div>
        </form>
        <div class="static-filters">
            <mat-chip *ngFor="let filter of savedFilterMap[selectedFilterSetId]?.staticFilters" class="static-filter-chip" data-hj-suppress>
                {{ getFilter(filter) }}
            </mat-chip>
        </div>
    </div>
</div>