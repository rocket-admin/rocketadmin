<div class="sidenav-header">
    <div *ngIf="collapsed; else tableHeader" class="collapsed-content">
        <!-- Show collections in collapsed state -->
        <div *ngIf="collections.length > 0" class="collapsed-collections">
            <div *ngFor="let collection of collections" 
                 class="collapsed-collection-item"
                 (click)="onCollapsedCollectionClick(collection)">
                <mat-icon *ngIf="collection.name === 'All Tables'" 
                          class="collapsed-collection-icon">table_view</mat-icon>
                <mat-icon *ngIf="collection.name !== 'All Tables'" 
                          class="collapsed-collection-icon">folder</mat-icon>
            </div>
        </div>
        <!-- Fallback to table_view if no collections -->
        <mat-icon *ngIf="collections.length === 0" class="collapsed-collection-icon">table_view</mat-icon>
    </div>
    <ng-template #tableHeader>
        <h1 class="mat-h2 connection-title">{{connectionTitle}}</h1>
    </ng-template>
</div>

<app-content-loader *ngIf="tables === null; else tablesList"></app-content-loader>

<ng-template #tablesList>
    <div *ngIf="tables && tables.length; else noTables" class="tables-list">
        
        
        <!-- Collapsed table list for All Tables -->
        <div *ngIf="collapsed && showCollapsedTableList" class="collapsed-tables-list">
            <a *ngFor="let table of getCollapsedTableList()" 
               class="collapsed-table-item"
               routerLink="/dashboard/{{connectionID}}/{{table.table}}"
               [queryParams]="{page_index: 0, page_size: 30}"
               [ngClass]="{'collapsed-table-item_active': selectedTable === table.table}"
               [matTooltip]="getTableName(table)"
               matTooltipPosition="right"
               (click)="closeSidebar()">
                <div class="collapsed-table-initials">
                    <span class="collapsed-table-text">{{getTableInitials(table)}}</span>
                </div>
            </a>
        </div>
        <mat-form-field *ngIf="!collapsed" appearance="fill" class="search-input">
            <input matInput name="search" #search="ngModel"
                placeholder="Search"
                [(ngModel)]="substringToSearch"
                (keyup)="searchSubstring()">
            <mat-error *ngIf="foundTables.length === 0">Nothing found.</mat-error>
        </mat-form-field>

        <div *ngIf="!collapsed" class="add-collection-button-container">
            <button mat-stroked-button color="primary" class="add-collection-button" (click)="onAddCollection()">
                <mat-icon>add</mat-icon>
                Add Collection
            </button>
        </div>

        <!-- Collections Section -->
        <div *ngIf="!collapsed && collections.length > 0" class="collections-section">
            <ng-container *ngFor="let collection of collections; trackBy: trackByCollectionId">
                <div *ngIf="shouldShowCollection(collection)"
                     class="collection-item" 
                     [class.expanded]="collection.expanded"
                     [class.drag-over]="dragOverCollection === collection.id"
                     (dragover)="onCollectionDragOver($event, collection.id)"
                     (dragleave)="onCollectionDragLeave($event, collection.id)"
                     (drop)="onCollectionDrop($event, collection)">
                    <div class="collection-header" (click)="toggleCollection(collection.id)">
                        <mat-icon class="collection-expand-icon" [class.expanded]="collection.expanded">
                            chevron_right
                        </mat-icon>
                        <div class="collection-name" 
                             [class.editing]="collection.editing"
                             *ngIf="!collection.editing; else collectionNameEdit"
                             (dblclick)="onCollectionNameDoubleClick($event, collection)">
                            {{collection.name}}
                        </div>
                        <div class="collection-actions">
                            <button *ngIf="getAvailableTables(collection).length > 0" 
                                    mat-icon-button class="add-table-button header-add" 
                                    (click)="$event.stopPropagation(); showAddTableDialog(collection)" 
                                    matTooltip="Add table to collection">
                                <mat-icon>add</mat-icon>
                            </button>
                            <button *ngIf="collection.name !== 'All Tables'" 
                                    mat-icon-button class="more-collection-button" 
                                    [matMenuTriggerFor]="collectionMenu"
                                    (click)="$event.stopPropagation()" 
                                    matTooltip="Collection options">
                                <mat-icon>more_vert</mat-icon>
                            </button>
                            <mat-menu #collectionMenu="matMenu" (closed)="onMenuClosed()">
                                <button mat-menu-item (click)="onCollectionNameDoubleClick($event, collection); closeMenu(collectionMenu)">
                                    <mat-icon>edit</mat-icon>
                                    <span>Rename</span>
                                </button>
                                <button mat-menu-item (click)="deleteCollection(collection); closeMenu(collectionMenu)">
                                    <mat-icon>delete</mat-icon>
                                    <span>Delete</span>
                                </button>
                            </mat-menu>
                        </div>
                        <ng-template #collectionNameEdit>
                            <div class="collection-name-edit-container">
                                <input class="collection-name editing"
                                       [(ngModel)]="collection.name"
                                       (blur)="finishEditCollection(collection)"
                                       (keyup.enter)="finishEditCollection(collection)"
                                       (keyup.escape)="cancelEditCollection(collection)"
                                       #collectionNameInput
                                       (click)="$event.stopPropagation()"
                                       (focus)="collectionNameInput.select()">
                                <mat-icon class="enter-icon" (click)="finishEditCollection(collection)">keyboard_return</mat-icon>
                            </div>
                        </ng-template>
                    </div>
                    <div *ngIf="collection.expanded" class="collection-tables">
                        <div *ngIf="getCollectionTables(collection).length > 0; else noTablesInCollection" 
                             class="selected-tables-list">
                            <div *ngFor="let table of getCollectionTables(collection)" 
                                 class="selected-table-item"
                                 [draggable]="true"
                                 (dragstart)="onTableDragStart($event, table)"
                                 (dragend)="onTableDragEnd($event)">
                                <a class="table-link" 
                                   routerLink="/dashboard/{{connectionID}}/{{table.table}}"
                                   [queryParams]="{page_index: 0, page_size: 30}"
                                   [ngClass]="{'table-link_active': selectedTable === table.table}"
                                   (click)="closeSidebar()">
                                    <span class="table-name">{{getTableName(table)}}</span>
                                </a>
                                <button *ngIf="collection.name !== 'All Tables'" 
                                        mat-icon-button class="remove-table-button" 
                                        (click)="removeTableFromCollection(collection, table, $event)"
                                        matTooltip="Remove from collection">
                                    <mat-icon>close</mat-icon>
                                </button>
                            </div>
                        </div>
                        <ng-template #noTablesInCollection>
                            <div class="no-tables-message">
                                <p>No tables in this collection</p>
                                <button mat-stroked-button color="primary" (click)="showAddTableDialog(collection)">
                                    <mat-icon>add</mat-icon>
                                    Add Table
                                </button>
                            </div>
                        </ng-template>
                    </div>
                </div>
            </ng-container>
        </div>

    </div>


    <ng-template #noTables>
        <p class="mat-body-1 empty-message">
            No tables in this connection.
        </p>

        <p class="mat-body-1 empty-message">
            Rocketadmin do not provide adding and deleting database tables, only editing ones. You can add a table with SQL editor.
        </p>
    </ng-template>

<!-- Add Table Dialog -->
<div class="add-table-dialog" *ngIf="showAddTableDialogFlag" (click)="closeAddTableDialog($event)">
    <div class="dialog-content" (click)="$event.stopPropagation()">
        <div class="dialog-header">
            <h3>Add Tables to {{currentCollection?.name}}</h3>
            <button mat-icon-button (click)="closeAddTableDialog()">
                <mat-icon>close</mat-icon>
            </button>
        </div>
        <div class="dialog-body">
            <div *ngFor="let table of getAvailableTables(currentCollection)" class="available-table-item">
                <mat-checkbox [checked]="selectedTablesForAdd.includes(table.table)" 
                              (change)="toggleTableSelection(table.table, $event)">
                    <span class="table-name">{{getTableName(table)}}</span>
                </mat-checkbox>
            </div>
        </div>
        <div class="dialog-actions">
            <button mat-button (click)="closeAddTableDialog()">Cancel</button>
            <button mat-raised-button color="primary" (click)="addSelectedTablesToCollection()">
                Add Selected
            </button>
        </div>
    </div>
</div>
