
<app-content-loader *ngIf="tables === null; else tablesList"></app-content-loader>

<ng-template #tablesList>
    <div *ngIf="tables && tables.length; else noTables" class="tables-list">
        
        <!-- Collapsed content when sidebar is collapsed -->
        <div *ngIf="collapsed" class="collapsed-content">
            <!-- Top section with search and folders -->
            <div class="collapsed-top-section">
                <!-- Search button -->
                <div class="collapsed-search-button" 
                     (click)="toggleCollapsedSearch()"
                     matTooltip="Search"
                     matTooltipPosition="right">
                    <mat-icon class="collapsed-action-icon">search</mat-icon>
                </div>
                
                <!-- Show folders in collapsed state -->
                <div *ngIf="folders.length > 0" class="collapsed-folders">
                    <div *ngFor="let folder of folders" 
                         class="collapsed-folder-item"
                         [class.collapsed-folder-item_active]="currentCollapsedFolder?.id === folder.id"
                         [matTooltip]="folder.name"
                         matTooltipPosition="right"
                         (click)="onCollapsedFolderClick(folder)">
                    <span *ngIf="folder.name === 'All Tables'" 
                          class="material-icons-outlined collapsed-folder-icon"
                          [style.color]="getFolderIconColor(folder)">dehaze</span>
                        <span *ngIf="folder.name !== 'All Tables'" 
                              class="material-icons-outlined collapsed-folder-icon"
                              [style.color]="getFolderIconColor(folder, currentCollapsedFolder === folder.id)">folder</span>
                    </div>
                </div>
                <!-- Fallback to dehaze if no folders -->
                <span *ngIf="folders.length === 0" 
                      class="material-icons-outlined collapsed-folder-icon"
                      matTooltip="All Tables"
                      matTooltipPosition="right">dehaze</span>
                
                <!-- Collapsed table list for any folder -->
                <div *ngIf="showCollapsedTableList" class="collapsed-tables-list">
                    <a *ngFor="let table of getCollapsedTableList()" 
                       class="collapsed-table-item"
                       routerLink="/dashboard/{{connectionID}}/{{table.table}}"
                       [queryParams]="{page_index: 0, page_size: 30}"
                       [ngClass]="{'collapsed-table-item_active': selectedTable === table.table}"
                       [matTooltip]="getTableName(table)"
                       matTooltipPosition="right"
                       (click)="closeSidebar()">
                        <!-- Show icon if available, otherwise show initials -->
                        <div *ngIf="hasTableIcon(table)" class="collapsed-table-icon-container">
                            <mat-icon class="collapsed-table-icon">{{getTableIcon(table)}}</mat-icon>
                        </div>
                        <div *ngIf="!hasTableIcon(table)" class="collapsed-table-initials">
                            <span class="collapsed-table-text">{{getTableInitials(table)}}</span>
                        </div>
                    </a>
                </div>
            </div>
            
            <!-- Bottom section with add folder button (fixed at bottom) -->
            <div class="collapsed-bottom-section">
                <!-- Add folder button -->
                <div class="collapsed-add-button" 
                     (click)="onAddFolder()"
                     matTooltip="Add Folder"
                     matTooltipPosition="right">
                    <mat-icon class="collapsed-action-icon">add</mat-icon>
                </div>
            </div>
        </div>
        
        <mat-form-field *ngIf="!collapsed" appearance="fill" class="search-input">
            <input matInput name="search" #search="ngModel"
                placeholder="Search"
                [(ngModel)]="substringToSearch"
                (keyup)="searchSubstring()">
            <mat-error *ngIf="foundTables.length === 0">Nothing found.</mat-error>
        </mat-form-field>

        <div *ngIf="!collapsed" class="add-folder-button-container">
            <button mat-stroked-button color="primary" class="add-folder-button" (click)="onAddFolder()">
                <mat-icon>add</mat-icon>
                Add Folder
            </button>
        </div>

        <!-- Collections Section -->
        <div *ngIf="!collapsed && folders.length > 0" class="folders-section">
            <ng-container *ngFor="let folder of folders; trackBy: trackByFolderId">
                <div *ngIf="shouldShowFolder(folder)"
                     class="folder-item" 
                     [class.expanded]="folder.expanded"
                     [class.drag-over]="dragOverFolder === folder.id"
                     (dragover)="onFolderDragOver($event, folder.id)"
                     (dragleave)="onFolderDragLeave($event, folder.id)"
                     (drop)="onFolderDrop($event, folder)">
                    <div class="folder-header" 
                         [class.expanded]="folder.expanded"
                         (click)="toggleFolder(folder.id)">
                        <!-- Folder icon on the left -->
                        <span *ngIf="folder.name === 'All Tables'" 
                              class="material-icons-outlined folder-icon"
                              [style.color]="getFolderIconColor(folder)">dehaze</span>
                        <span *ngIf="folder.name !== 'All Tables'" 
                              class="material-icons-outlined folder-icon"
                              [style.color]="getFolderIconColor(folder)">folder</span>
                        
                        <div class="folder-name" 
                             [class.editing]="folder.editing"
                             *ngIf="!folder.editing; else folderNameEdit"
                             (dblclick)="onFolderNameDoubleClick($event, folder)">
                            {{folder.name}}
                        </div>
                        
                        <div class="folder-actions">
                            <button *ngIf="folder.name !== 'All Tables'" 
                                    mat-icon-button class="more-folder-button" 
                                    [matMenuTriggerFor]="folderMenu"
                                    (click)="$event.stopPropagation()" 
                                    matTooltip="Folder options">
                                <mat-icon>more_vert</mat-icon>
                            </button>
                            
                            <!-- Expand/collapse icon on the right -->
                            <mat-icon class="folder-expand-icon" [class.expanded]="folder.expanded">
                                chevron_right
                            </mat-icon>
                            <mat-menu #folderMenu="matMenu" (closed)="onMenuClosed()">
                                <button mat-menu-item (click)="onFolderNameDoubleClick($event, folder); closeMenu(folderMenu)">
                                    <span class="material-icons-outlined">edit</span>
                                    <span>Rename</span>
                                </button>
                                <button mat-menu-item (click)="showEditTablesDialog(folder); closeMenu(folderMenu)">
                                    <span class="material-icons-outlined">edit_note</span>
                                    <span>Edit</span>
                                </button>
                                <button mat-menu-item (click)="deleteFolder(folder); closeMenu(folderMenu)">
                                    <span class="material-icons-outlined">delete</span>
                                    <span>Delete</span>
                                </button>
                            </mat-menu>
                        </div>
                        <ng-template #folderNameEdit>
                            <div class="folder-name-edit-container">
                                <input class="folder-name editing"
                                       [(ngModel)]="folder.name"
                                       (blur)="finishEditFolder(folder)"
                                       (keyup.enter)="finishEditFolder(folder)"
                                       (keyup.escape)="cancelEditFolder(folder)"
                                       #folderNameInput
                                       (click)="$event.stopPropagation()"
                                       (focus)="folderNameInput.select()">
                                <mat-icon class="enter-icon" (click)="finishEditFolder(folder)">keyboard_return</mat-icon>
                            </div>
                        </ng-template>
                    </div>
                    <div *ngIf="folder.expanded" class="folder-tables">
                        <div *ngIf="getFolderTables(folder).length > 0; else noTablesInCollection" 
                             class="selected-tables-list">
                            <div *ngFor="let table of getFolderTables(folder)" 
                                 class="selected-table-item"
                                 [draggable]="true"
                                 (dragstart)="onTableDragStart($event, table)"
                                 (dragend)="onTableDragEnd($event)">
                                <a class="table-link" 
                                   routerLink="/dashboard/{{connectionID}}/{{table.table}}"
                                   [queryParams]="{page_index: 0, page_size: 30}"
                                   [ngClass]="{'table-link_active': selectedTable === table.table}"
                                   (click)="closeSidebar()">
                                    <span class="table-name">{{getTableName(table)}}</span>
                                </a>
                            </div>
                            
                        </div>
                        <ng-template #noTablesInCollection>
                            <div class="no-tables-message">
                                <p>No tables in this folder</p>
                                <button mat-stroked-button color="primary" (click)="showEditTablesDialog(folder)">
                                    <mat-icon>add</mat-icon>
                                    Add Table
                                </button>
                            </div>
                        </ng-template>
                    </div>
                </div>
            </ng-container>
        </div>

    </div>


    <ng-template #noTables>
        <p class="mat-body-1 empty-message">
            No tables in this connection.
        </p>

        <p class="mat-body-1 empty-message">
            Rocketadmin do not provide adding and deleting database tables, only editing ones. You can add a table with SQL editor.
        </p>
    </ng-template>

<!-- Edit Tables Dialog -->
<div class="edit-tables-dialog" *ngIf="showEditTablesDialogFlag" (click)="closeEditTablesDialog($event)">
    <div class="dialog-content" (click)="$event.stopPropagation()">
        <div class="dialog-header">
            <h3>Edit Tables in {{currentFolder?.name}}</h3>
        </div>
        <div class="dialog-body">
            <!-- Folder Color Section -->
            <div class="folder-color-section">
                <h4>Folder Icon Color</h4>
                <div class="color-row">
                    <button *ngFor="let color of folderIconColors" 
                            class="color-option"
                            [style.background-color]="color.value"
                            [class.selected]="currentFolder && getFolderIconColor(currentFolder) === color.value"
                            (click)="changeFolderIconColor(color.value)"
                            [title]="color.name">
                    </button>
                </div>
            </div>
            
            <div class="tables-section">
                <h4>Manage tables in this folder</h4>
                <div class="table-list">
                <div *ngFor="let table of allTables" class="table-item">
                    <span class="table-name">{{getTableName(table)}}</span>
                    <button mat-button 
                            class="action-button"
                            [class.add-button]="!isTableInFolder(table)"
                            [class.remove-button]="isTableInFolder(table)"
                            (click)="toggleTableInFolder(table)">
                        {{isTableInFolder(table) ? 'Remove' : 'Add'}}
                    </button>
                </div>
            </div>
            </div>
        </div>
    </div>
</div>

