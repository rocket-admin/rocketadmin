<app-alert></app-alert>

<div class="secrets-page">
    <div class="secrets-header">
        <h1 class="mat-h1">Company Secrets</h1>
        <p class="secrets-description">
            Securely store and manage sensitive information like API keys, passwords, and tokens.
        </p>
    </div>

    <div class="secrets-toolbar">
        <mat-form-field appearance="outline" class="search-field">
            <mat-label>Search secrets</mat-label>
            <input matInput
                [(ngModel)]="searchQuery"
                (ngModelChange)="onSearchChange($event)"
                placeholder="Search by slug..."
                data-testid="secrets-search-input">
            <mat-icon matSuffix>search</mat-icon>
        </mat-form-field>

        <button mat-flat-button color="primary"
            (click)="openCreateDialog()"
            data-testid="create-secret-button">
            <mat-icon>add</mat-icon>
            Create Secret
        </button>
    </div>

    <app-placeholder-table-data *ngIf="loading"></app-placeholder-table-data>

    <div *ngIf="!loading && secrets.length === 0" class="no-secrets">
        <mat-icon class="no-secrets-icon">key_off</mat-icon>
        <h3>No secrets found</h3>
        <p *ngIf="searchQuery">No secrets match your search criteria.</p>
        <p *ngIf="!searchQuery">Create your first secret to securely store sensitive data.</p>
        <button *ngIf="!searchQuery" mat-stroked-button color="primary" (click)="openCreateDialog()">
            <mat-icon>add</mat-icon>
            Create Secret
        </button>
    </div>

    <table *ngIf="!loading && secrets.length > 0" mat-table [dataSource]="secrets" class="mat-elevation-z2 secrets-table">
        <!-- Slug Column -->
        <ng-container matColumnDef="slug">
            <th mat-header-cell *matHeaderCellDef>Slug</th>
            <td mat-cell *matCellDef="let secret; let i = index"
                class="secrets-cell secrets-cell_slug"
                data-label="Slug"
                attr.data-testid="secret-slug-{{i}}-cell">
                <span class="slug-text">{{secret.slug}}</span>
            </td>
        </ng-container>

        <!-- Master Encryption Column -->
        <ng-container matColumnDef="masterEncryption">
            <th mat-header-cell *matHeaderCellDef>Encryption</th>
            <td mat-cell *matCellDef="let secret; let i = index"
                class="secrets-cell"
                data-label="Encryption"
                attr.data-testid="secret-encryption-{{i}}-cell">
                <mat-icon *ngIf="secret.masterEncryption"
                    class="encryption-icon encryption-icon_master"
                    matTooltip="Protected with master password">
                    enhanced_encryption
                </mat-icon>
                <mat-icon *ngIf="!secret.masterEncryption"
                    class="encryption-icon"
                    matTooltip="Standard encryption">
                    lock
                </mat-icon>
            </td>
        </ng-container>

        <!-- Expires At Column -->
        <ng-container matColumnDef="expiresAt">
            <th mat-header-cell *matHeaderCellDef>Expires</th>
            <td mat-cell *matCellDef="let secret; let i = index"
                class="secrets-cell"
                data-label="Expires"
                attr.data-testid="secret-expires-{{i}}-cell">
                <span *ngIf="!secret.expiresAt" class="no-expiry">Never</span>
                <span *ngIf="secret.expiresAt && isExpired(secret)" class="expired-badge">
                    <mat-icon>error</mat-icon>
                    Expired
                </span>
                <span *ngIf="secret.expiresAt && isExpiringSoon(secret) && !isExpired(secret)" class="expiring-soon-badge">
                    <mat-icon>warning</mat-icon>
                    {{secret.expiresAt | date:'mediumDate'}}
                </span>
                <span *ngIf="secret.expiresAt && !isExpired(secret) && !isExpiringSoon(secret)">
                    {{secret.expiresAt | date:'mediumDate'}}
                </span>
            </td>
        </ng-container>

        <!-- Updated At Column -->
        <ng-container matColumnDef="updatedAt">
            <th mat-header-cell *matHeaderCellDef>Last Updated</th>
            <td mat-cell *matCellDef="let secret; let i = index"
                class="secrets-cell"
                data-label="Last Updated"
                attr.data-testid="secret-updated-{{i}}-cell">
                {{secret.updatedAt | date:'medium'}}
            </td>
        </ng-container>

        <!-- Actions Column -->
        <ng-container matColumnDef="actions">
            <th mat-header-cell *matHeaderCellDef></th>
            <td mat-cell *matCellDef="let secret; let i = index"
                class="secrets-cell secrets-cell_actions">
                <button mat-icon-button [matMenuTriggerFor]="actionsMenu"
                    attr.data-testid="secret-actions-{{i}}-button">
                    <mat-icon>more_vert</mat-icon>
                </button>
                <mat-menu #actionsMenu="matMenu">
                    <button mat-menu-item (click)="openEditDialog(secret)"
                        [disabled]="isExpired(secret)"
                        attr.data-testid="secret-edit-{{i}}-menu-item">
                        <mat-icon>edit</mat-icon>
                        <span>Edit</span>
                    </button>
                    <button mat-menu-item (click)="openAuditLogDialog(secret)"
                        attr.data-testid="secret-audit-{{i}}-menu-item">
                        <mat-icon>history</mat-icon>
                        <span>Audit Log</span>
                    </button>
                    <mat-divider></mat-divider>
                    <button mat-menu-item (click)="openDeleteDialog(secret)" class="delete-action"
                        attr.data-testid="secret-delete-{{i}}-menu-item">
                        <mat-icon color="warn">delete</mat-icon>
                        <span>Delete</span>
                    </button>
                </mat-menu>
            </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumns" class="secrets-table-heading"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedColumns;" class="secrets-row"></tr>
    </table>

    <mat-paginator *ngIf="!loading && secrets.length > 0"
        [length]="pagination.total"
        [pageSize]="pagination.perPage"
        [pageIndex]="pagination.currentPage - 1"
        [pageSizeOptions]="[10, 20, 50]"
        (page)="onPageChange($event)"
        data-testid="secrets-paginator">
    </mat-paginator>
</div>
