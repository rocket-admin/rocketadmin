<h2 mat-dialog-title>Edit Secret: {{data.secret.slug}}</h2>

<mat-dialog-content>
    <!-- Loading State -->
    <div *ngIf="loading" class="loading-container">
        <mat-spinner diameter="40"></mat-spinner>
        <p>Loading secret...</p>
    </div>

    <!-- Master Password Required -->
    <div *ngIf="!loading && requiresMasterPassword" class="master-password-container">
        <mat-icon class="lock-icon">enhanced_encryption</mat-icon>
        <h3>Master Password Required</h3>
        <p>This secret is protected with master password encryption.</p>

        <mat-form-field appearance="outline" class="full-width">
            <mat-label>Master Password</mat-label>
            <input matInput
                [(ngModel)]="masterPassword"
                [type]="showMasterPassword ? 'text' : 'password'"
                (keyup.enter)="submitMasterPassword()"
                placeholder="Enter master password"
                data-testid="edit-secret-master-password-input">
            <button mat-icon-button matSuffix type="button"
                (click)="toggleMasterPasswordVisibility()"
                [matTooltip]="showMasterPassword ? 'Hide password' : 'Show password'">
                <mat-icon>{{showMasterPassword ? 'visibility_off' : 'visibility'}}</mat-icon>
            </button>
            <mat-error *ngIf="masterPasswordError">{{masterPasswordError}}</mat-error>
        </mat-form-field>

        <button mat-flat-button color="primary"
            (click)="submitMasterPassword()"
            data-testid="edit-secret-unlock-button">
            <mat-icon>lock_open</mat-icon>
            Unlock Secret
        </button>
    </div>

    <!-- Edit Form -->
    <form *ngIf="!loading && !requiresMasterPassword"
        [formGroup]="form"
        (ngSubmit)="onSubmit()"
        id="editSecretForm">

        <mat-form-field appearance="outline" class="full-width">
            <mat-label>Secret Value</mat-label>
            <textarea matInput formControlName="value"
                [type]="showValue ? 'text' : 'password'"
                rows="4"
                placeholder="Enter your secret value"
                data-testid="edit-secret-value-input"></textarea>
            <button mat-icon-button matSuffix type="button"
                (click)="toggleValueVisibility()"
                [matTooltip]="showValue ? 'Hide value' : 'Show value'">
                <mat-icon>{{showValue ? 'visibility_off' : 'visibility'}}</mat-icon>
            </button>
            <mat-error *ngIf="form.get('value')?.invalid">{{valueError}}</mat-error>
        </mat-form-field>

        <div class="expiration-section">
            <mat-form-field appearance="outline" class="full-width">
                <mat-label>Expiration Date</mat-label>
                <input matInput [matDatepicker]="picker" formControlName="expiresAt"
                    [min]="minDate"
                    data-testid="edit-secret-expires-input">
                <mat-datepicker-toggle matIconSuffix [for]="picker"></mat-datepicker-toggle>
                <mat-datepicker #picker></mat-datepicker>
            </mat-form-field>

            <mat-checkbox
                [checked]="clearExpiration"
                (change)="onClearExpirationChange($event.checked)"
                data-testid="edit-secret-clear-expiration-checkbox">
                Remove expiration date
            </mat-checkbox>
        </div>

        <p *ngIf="data.secret.masterEncryption" class="encryption-note">
            <mat-icon>info</mat-icon>
            This secret uses master password encryption. Your changes will be encrypted with the same master password.
        </p>
    </form>
</mat-dialog-content>

<mat-dialog-actions align="end">
    <button mat-button mat-dialog-close [disabled]="submitting">Cancel</button>
    <button mat-flat-button color="primary"
        *ngIf="!loading && !requiresMasterPassword"
        type="submit"
        form="editSecretForm"
        [disabled]="form.invalid || submitting"
        data-testid="edit-secret-submit-button">
        {{submitting ? 'Saving...' : 'Save Changes'}}
    </button>
</mat-dialog-actions>
