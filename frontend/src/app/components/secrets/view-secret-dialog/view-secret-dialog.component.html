<h2 mat-dialog-title>
    <mat-icon class="title-icon">key</mat-icon>
    {{data.secret.slug}}
</h2>

<mat-dialog-content>
    <!-- Loading State -->
    <div *ngIf="loading" class="loading-container">
        <mat-spinner diameter="40"></mat-spinner>
        <p>Loading secret...</p>
    </div>

    <!-- Master Password Required -->
    <div *ngIf="!loading && requiresMasterPassword" class="master-password-container">
        <mat-icon class="lock-icon">enhanced_encryption</mat-icon>
        <h3>Master Password Required</h3>
        <p>This secret is protected with master password encryption.</p>

        <mat-form-field appearance="outline" class="full-width">
            <mat-label>Master Password</mat-label>
            <input matInput
                [(ngModel)]="masterPassword"
                [type]="showMasterPassword ? 'text' : 'password'"
                (keyup.enter)="submitMasterPassword()"
                placeholder="Enter master password"
                data-testid="view-secret-master-password-input">
            <button mat-icon-button matSuffix type="button"
                (click)="toggleMasterPasswordVisibility()"
                [matTooltip]="showMasterPassword ? 'Hide password' : 'Show password'">
                <mat-icon>{{showMasterPassword ? 'visibility_off' : 'visibility'}}</mat-icon>
            </button>
            <mat-error *ngIf="masterPasswordError">{{masterPasswordError}}</mat-error>
        </mat-form-field>

        <button mat-flat-button color="primary"
            (click)="submitMasterPassword()"
            data-testid="view-secret-unlock-button">
            <mat-icon>lock_open</mat-icon>
            Unlock Secret
        </button>
    </div>

    <!-- Secret Details -->
    <div *ngIf="!loading && !requiresMasterPassword && secret" class="secret-details">
        <!-- Expired Warning -->
        <div *ngIf="isExpired()" class="expired-warning">
            <mat-icon>error</mat-icon>
            <span>This secret has expired on {{secret.expiresAt | date:'medium'}}</span>
        </div>

        <!-- Secret Value -->
        <div class="value-section">
            <label class="section-label">Secret Value</label>
            <div class="value-container">
                <div class="value-display" [class.masked]="!showValue">
                    {{showValue ? secret.value : '••••••••••••••••••••'}}
                </div>
                <div class="value-actions">
                    <button mat-icon-button
                        (click)="toggleValueVisibility()"
                        [matTooltip]="showValue ? 'Hide value' : 'Show value'"
                        data-testid="view-secret-toggle-visibility">
                        <mat-icon>{{showValue ? 'visibility_off' : 'visibility'}}</mat-icon>
                    </button>
                    <button mat-icon-button
                        (click)="copyToClipboard()"
                        matTooltip="Copy to clipboard"
                        data-testid="view-secret-copy-button">
                        <mat-icon>content_copy</mat-icon>
                    </button>
                </div>
            </div>
        </div>

        <!-- Metadata -->
        <div class="metadata-section">
            <div class="metadata-item">
                <label>Created</label>
                <span>{{secret.createdAt | date:'medium'}}</span>
            </div>
            <div class="metadata-item">
                <label>Last Updated</label>
                <span>{{secret.updatedAt | date:'medium'}}</span>
            </div>
            <div class="metadata-item" *ngIf="secret.lastAccessedAt">
                <label>Last Accessed</label>
                <span>{{secret.lastAccessedAt | date:'medium'}}</span>
            </div>
            <div class="metadata-item">
                <label>Expires</label>
                <span *ngIf="secret.expiresAt">{{secret.expiresAt | date:'medium'}}</span>
                <span *ngIf="!secret.expiresAt" class="no-expiry">Never</span>
            </div>
            <div class="metadata-item">
                <label>Encryption</label>
                <span *ngIf="secret.masterEncryption" class="master-encrypted">
                    <mat-icon>enhanced_encryption</mat-icon>
                    Master password protected
                </span>
                <span *ngIf="!secret.masterEncryption">
                    <mat-icon>lock</mat-icon>
                    Standard encryption
                </span>
            </div>
        </div>
    </div>
</mat-dialog-content>

<mat-dialog-actions align="end">
    <button mat-button mat-dialog-close data-testid="view-secret-close-button">Close</button>
</mat-dialog-actions>
