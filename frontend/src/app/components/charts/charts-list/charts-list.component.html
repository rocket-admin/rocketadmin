<app-alert></app-alert>

<div class="charts-page">
    <div class="charts-header">
        <h1 class="mat-h1">Saved Queries</h1>
        <p class="charts-description">
            Create and manage saved SQL queries with chart visualizations.
        </p>
    </div>

    <div class="charts-toolbar">
        <mat-form-field appearance="outline" class="search-field">
            <mat-label>Search queries</mat-label>
            <input matInput
                [(ngModel)]="searchQuery"
                (ngModelChange)="onSearchChange($event)"
                placeholder="Search by name or description..."
                data-testid="charts-search-input">
            <mat-icon matSuffix>search</mat-icon>
        </mat-form-field>

        <button mat-flat-button color="primary"
            (click)="openCreatePage()"
            data-testid="create-chart-button">
            <mat-icon>add</mat-icon>
            Create Query
        </button>
    </div>

    <app-placeholder-table-data *ngIf="loading"></app-placeholder-table-data>

    <div *ngIf="!loading && filteredQueries.length === 0" class="no-charts">
        <mat-icon class="no-charts-icon">bar_chart</mat-icon>
        <h3>No saved queries found</h3>
        <p *ngIf="searchQuery">No queries match your search criteria.</p>
        <p *ngIf="!searchQuery">Create your first saved query to visualize your data.</p>
        <button *ngIf="!searchQuery" mat-stroked-button color="primary" (click)="openCreatePage()">
            <mat-icon>add</mat-icon>
            Create Query
        </button>
    </div>

    <table *ngIf="!loading && filteredQueries.length > 0" mat-table [dataSource]="filteredQueries" class="mat-elevation-z2 charts-table">
        <!-- Name Column -->
        <ng-container matColumnDef="name">
            <th mat-header-cell *matHeaderCellDef>Name</th>
            <td mat-cell *matCellDef="let query; let i = index"
                class="charts-cell charts-cell_name"
                data-label="Name"
                attr.data-testid="chart-name-{{i}}-cell">
                <span class="name-text">{{query.name}}</span>
            </td>
        </ng-container>

        <!-- Description Column -->
        <ng-container matColumnDef="description">
            <th mat-header-cell *matHeaderCellDef>Description</th>
            <td mat-cell *matCellDef="let query; let i = index"
                class="charts-cell"
                data-label="Description"
                attr.data-testid="chart-description-{{i}}-cell">
                <span *ngIf="query.description" class="description-text">{{query.description}}</span>
                <span *ngIf="!query.description" class="no-description">No description</span>
            </td>
        </ng-container>

        <!-- Updated At Column -->
        <ng-container matColumnDef="updatedAt">
            <th mat-header-cell *matHeaderCellDef>Last Updated</th>
            <td mat-cell *matCellDef="let query; let i = index"
                class="charts-cell"
                data-label="Last Updated"
                attr.data-testid="chart-updated-{{i}}-cell">
                {{query.updated_at | date:'medium'}}
            </td>
        </ng-container>

        <!-- Actions Column -->
        <ng-container matColumnDef="actions">
            <th mat-header-cell *matHeaderCellDef></th>
            <td mat-cell *matCellDef="let query; let i = index"
                class="charts-cell charts-cell_actions">
                <button mat-icon-button [matMenuTriggerFor]="actionsMenu"
                    attr.data-testid="chart-actions-{{i}}-button">
                    <mat-icon>more_vert</mat-icon>
                </button>
                <mat-menu #actionsMenu="matMenu">
                    <button mat-menu-item (click)="openEditPage(query)"
                        attr.data-testid="chart-edit-{{i}}-menu-item">
                        <mat-icon>edit</mat-icon>
                        <span>Edit</span>
                    </button>
                    <mat-divider></mat-divider>
                    <button mat-menu-item (click)="openDeleteDialog(query)" class="delete-action"
                        attr.data-testid="chart-delete-{{i}}-menu-item">
                        <mat-icon color="warn">delete</mat-icon>
                        <span>Delete</span>
                    </button>
                </mat-menu>
            </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumns" class="charts-table-heading"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedColumns;" class="charts-row"></tr>
    </table>
</div>
