<div class="charts-layout">
    <app-dashboards-sidebar
        [connectionId]="connectionId()"
        activeTab="queries">
    </app-dashboards-sidebar>

    <div class="charts-main">
        <app-alert></app-alert>

        <div class="charts-page">
            <div class="charts-header">
                <h1 class="mat-h1">Widgets</h1>
                <p class="charts-description">
                    Create and manage widgets with chart visualizations for your dashboards.
                </p>
            </div>

            <div class="charts-toolbar">
                <mat-form-field appearance="outline" class="search-field">
                    <mat-label>Search widgets</mat-label>
                    <input matInput
                        [ngModel]="searchQuery()"
                        (ngModelChange)="searchQuery.set($event)"
                        placeholder="Search by name or description..."
                        data-testid="widgets-search-input">
                    <mat-icon matSuffix>search</mat-icon>
                </mat-form-field>

                <a mat-flat-button color="primary"
                    [routerLink]="['/charts', connectionId(), 'new']"
                    (click)="trackCreatePageOpened()"
                    data-testid="create-widget-button">
                    <mat-icon>add</mat-icon>
                    Create Widget
                </a>
            </div>

            <app-placeholder-table-data *ngIf="loading()"></app-placeholder-table-data>

            <div *ngIf="!loading() && filteredQueries().length === 0" class="no-widgets">
                <mat-icon class="no-widgets-icon">widgets</mat-icon>
                <h3>No widgets found</h3>
                <p *ngIf="searchQuery()">No widgets match your search criteria.</p>
                <p *ngIf="!searchQuery()">Create your first widget to visualize your data.</p>
                <a *ngIf="!searchQuery()" mat-stroked-button color="primary"
                    [routerLink]="['/charts', connectionId(), 'new']"
                    (click)="trackCreatePageOpened()">
                    <mat-icon>add</mat-icon>
                    Create Widget
                </a>
            </div>

            <div *ngIf="!loading() && filteredQueries().length > 0" class="widgets-grid">
                <mat-card *ngFor="let query of filteredQueries(); let i = index"
                    class="widget-card"
                    attr.data-testid="widget-card-{{i}}">

                    <!-- Preview area -->
                    <a [routerLink]="['/charts', connectionId(), query.id]"
                        (click)="trackEditPageOpened()"
                        class="widget-preview">
                        <app-chart-mini-preview [chartType]="query.chart_type"></app-chart-mini-preview>
                    </a>

                    <!-- Card content -->
                    <mat-card-content class="widget-card-content">
                        <div class="widget-card-header">
                            <a [routerLink]="['/charts', connectionId(), query.id]"
                                (click)="trackEditPageOpened()"
                                class="widget-name">
                                {{query.name}}
                            </a>
                            <button mat-icon-button [matMenuTriggerFor]="cardMenu"
                                class="widget-menu-button"
                                attr.data-testid="widget-actions-{{i}}-button">
                                <mat-icon>more_vert</mat-icon>
                            </button>
                            <mat-menu #cardMenu="matMenu">
                                <a mat-menu-item
                                    [routerLink]="['/charts', connectionId(), query.id]"
                                    (click)="trackEditPageOpened()"
                                    attr.data-testid="widget-edit-{{i}}-menu-item">
                                    <mat-icon>edit</mat-icon>
                                    <span>Edit</span>
                                </a>
                                <mat-divider></mat-divider>
                                <button mat-menu-item (click)="openDeleteDialog(query)" class="delete-action"
                                    attr.data-testid="widget-delete-{{i}}-menu-item">
                                    <mat-icon color="warn">delete</mat-icon>
                                    <span>Delete</span>
                                </button>
                            </mat-menu>
                        </div>
                        <p *ngIf="query.description" class="widget-description-text">
                            {{query.description}}
                        </p>
                        <div class="widget-meta">
                            <span class="widget-updated">
                                {{query.updated_at | date:'mediumDate'}}
                            </span>
                        </div>
                    </mat-card-content>
                </mat-card>
            </div>
        </div>
    </div>
</div>
